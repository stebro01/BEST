<template>
  <q-page>
    <MainSlot>
      <!-- HEADING -->
      <template v-slot:header>
        <HEADING :title="TEXT.title" :img="'concept-import-logo.png'" :icon="'dashboard_customize'"/>
      </template>

      <template v-slot:options_right>
        <FILTER_BOX :filter="filter" @update="filter = $event" />
      </template>

      <!-- MAIN -->
      <template v-slot:main>
        <q-table class="my-table" :rows="SCHEMES" row-key="CODE_CD" :columns="columns" dense
          :rows-per-page-options="[10, 25, 50, 100]" :filter="filter" v-model:expanded="expanded">
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th auto-width />

              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                {{ col.label }}
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td auto-width>
                <q-toggle v-model="props.expand" checked-icon="add" unchecked-icon="remove" @update:model-value="edit_mode = false"/>
              </q-td>

              <q-td v-for="col in props.cols" :key="col.name" :props="props">
                {{ col.value }}
              </q-td>
            </q-tr>
            <q-tr v-if="props.expand" :props="props">
              <q-td colspan="100%">
                <div class="text-left text-bold"> {{ props.row.LOOKUP_JSON.title }}</div>
                <div class="text-left text-caption"> {{ props.row.LOOKUP_JSON.description }}</div>
                <div class="row q-gutter-md" :class="{'justify-between': props.row.LOOKUP_JSON.data.length > 4}">
                  <q-card v-for="(item, ind) in props.row.LOOKUP_JSON.data" :key="ind + 'scheme'" dense>
                    <q-card-section>
                      <q-item-label><RESOLVE_CONCEPT :item="item.CONCEPT_CD"/></q-item-label>
                      <q-item-label caption>{{ item.CONCEPT_CD }}</q-item-label>
                     
                    </q-card-section>
                  </q-card>
                </div>

              </q-td>
            </q-tr>
          </template>

        </q-table>

      </template>

      <!-- FOOTER -->
      <template v-slot:footer>
        <BOTTOM_BUTTONS v-if="SCHEMES" :show_edit="expanded.length === 1" :show_delete="expanded.length > 0" :show_export="expanded.length === 1"
          :show_add="expanded.length === 0" @edit="editData(expanded[0])" @delete="deleteData(expanded)" :show_import="expanded.length === 0"
          @add="addData()" @export="exportScheme(expanded[0])" @import="show_import_dialog = true"/>
      </template>
    </MainSlot>

    <!-- IMPORT DIALOG -->
    <q-dialog v-model="show_import_dialog">

      <q-card class="q-pa-md">
        <q-btn icon="close" round flat class="absolute-top-right z-top" v-close-popup />

        <q-card-section>
          JSON File mit Scheme importieren
        </q-card-section>
        <q-card-section class="q-pa-none">
          <SELECT_FILE :accept="'.json'" @save="importScheme($event)"/>
        </q-card-section>  

      </q-card>

    </q-dialog>

  </q-page>
</template>

<script>


import BOTTOM_BUTTONS from 'src/components/elements/BottomButtons.vue'
import HEADING from 'src/components/elements/Heading.vue'
import FILTER_BOX from 'src/components/elements/FilterBox.vue'
import MainSlot from 'src/components/MainSlot.vue'
import RESOLVE_CONCEPT from 'src/components/elements/ResolveConcept.vue'
import SELECT_FILE from 'src/components/elements/SelectFile.vue'
import { unstringify } from 'src/classes/sqltools'
import { exportFile } from 'quasar'
import { my_confirm } from "src/tools/my_dialog";

export default {
  name: 'DBFunctions_EditSchemes',

  components: { BOTTOM_BUTTONS, HEADING, FILTER_BOX, MainSlot, RESOLVE_CONCEPT, SELECT_FILE },

  data() {
    return {
      SCHEMES: [],
      filter: undefined,
      expanded: [],
      columns: [
      { name: 'CODE_CD',required: true,label: 'ID',align: 'center',field: 'CODE_CD',sortable: true},
      { name: 'NAME_CHAR',required: true,label: 'Bez.',align: 'left',field: 'NAME_CHAR',sortable: true},
      ],
      show_import_dialog: false
    }
  },

  mounted() {
   this.loadLocalData()
  },

  watch: {


  },

  computed: {
    TEXT() {
      return this.$store.getters.TEXT.page.schemes_edit
    }
  },

  methods: {
    loadLocalData() {
      this.$store.dispatch('searchDB', { query_string: {COLUMN_CD: 'SCHEME_CD'}, table: "CODE_LOOKUP"})
      .then(res => this.formatResult(res))
    },

    formatResult(res) {
      this.SCHEMES = res
      this.SCHEMES.forEach(s => {
        s.LOOKUP_JSON = JSON.parse(unstringify(s.LOOKUP_BLOB))
      })
    },

    addData() {
      this.$router.push({name: 'DBFunctions_EditSchemes_New'})
    },

    editData(val) {
      this.$router.push({name: 'DBFunctions_EditSchemes_Edit', params: {id: val}})
    },

    async deleteData(val) {
      if (!await my_confirm(this.$store.getters.TEXT.msg.confirm_delete)) return
      const promises = []
      val.forEach(item => {
        let obj = this.SCHEMES.find(el => el.CODE_CD === item)
        promises.push(this.$store.dispatch('deleteDB', {query_string: {CODE_CD: obj.CODE_CD}, table: 'CODE_LOOKUP'}))
      })

      Promise.all(promises).finally(() => {
        this.$q.notify(this.$store.getters.TEXT.msg.action_successful)
        this.expanded = []
        this.loadLocalData()
      })
      
    },

    exportScheme(val) {
      let obj = this.SCHEMES.find(el => el.CODE_CD === val)
      if (!obj) return this.$q.notify('Scheme nicht gefunden ...')
      // else
      var TXT = JSON.stringify(obj)
      const status = exportFile(`DBscheme_${val}.json`, TXT)
      if (status === true) return this.$q.notify('Export erfolgreich')
      else this.$q.notify('Export fehlgeschlagen.')
    },

    async importScheme(val) {
      this.show_import_dialog = false
      const txt = window.electron.readFile(val.path, "utf8");
      try {
        const json = JSON.parse(txt)
        if (!json.TABLE_CD || json.TABLE_CD !== 'SCHEME_CD') return this.$q.notify('JSON enthält keine gültigen Daten.')

        this.$store.dispatch('addDB', {query_string: json, table: 'CODE_LOOKUP'})
          .then(res => {
            this.$q.notify(this.$store.getters.TEXT.msg.action_successful)
          }).catch(err => this.$q.notify(err))
          .finally(() => this.loadLocalData())
        
      } catch (e) {
        return this.$q.notify('Datei ist kein gültiges JSON-Format.')
      }
      
    }
  }

}
</script>
